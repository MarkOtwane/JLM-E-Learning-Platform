<div class="dashboard-container">
  <!-- ========================================
       MAIN CONTENT
       ======================================== -->
  <main class="main-content">
    <!-- ========================================
         WELCOME SECTION
         ======================================== -->
    <div class="welcome-section">
      <!-- Dynamic Profile Section -->
      <div class="profile" (click)="onProfileClick()">
        <!-- Profile Picture with Fallback -->
        <img
          *ngIf="!isLoading && loggedInUser && hasProfilePicture(); else profilePlaceholder"
          [src]="getProfilePictureUrl()"
          alt="User Profile"
          class="profile-pic"
        />

        <!-- Profile Picture Placeholder -->
        <ng-template #profilePlaceholder>
          <div class="profile-pic-placeholder">
            {{ getUserInitials() }}
          </div>
        </ng-template>

        <!-- Dynamic User Name and Year -->
        <span class="user-name">{{ getLoggedInStudentName() }}</span>
      </div>

      <!-- Welcome Text with Dynamic Greeting -->
      <div class="welcome-text">
        <h2>{{ getWelcomeMessage() }}</h2>
        <p class="student-email">{{ loggedInUser?.email }}</p>
        <p>Always stay updated in your student portal</p>

        <!-- Additional User Info -->
        <div class="user-stats" *ngIf="!isLoading">
          <span class="stat">{{ enrolledCourses.length }} Courses</span>
          <span class="stat">{{ getTotalCredits() }} Credits</span>
          <span class="stat" *ngIf="userProfile.program">{{
            userProfile.program
          }}</span>
        </div>
      </div>
    </div>

    <!-- ========================================
         LOADING STATE
         ======================================== -->
    <div *ngIf="isLoading" class="loading-section">
      <div class="loading-spinner"></div>
      <p>Loading your dashboard...</p>
    </div>

    <!-- ========================================
         CONTENT SECTIONS
         ======================================== -->
    <div class="content-sections" *ngIf="!isLoading">
      <!-- Enrolled Courses Section -->
      <section class="enrolled-courses">
        <h3>Enrolled Courses</h3>

        <!-- No Courses Message -->
        <div *ngIf="enrolledCourses.length === 0" class="no-content">
          <p>You are not enrolled in any courses yet.</p>
        </div>

        <!-- Course List -->
        <div class="course-list" *ngFor="let course of enrolledCourses">
          <div class="course-card" (click)="onCourseClick(course)">
            <div class="course-info">
              <h4>{{ course.title || course.name }}</h4>
              <div class="course-details">
                <span *ngIf="course.code" class="course-code">{{
                  course.code
                }}</span>
                <span *ngIf="course.credits" class="course-credits">
                  {{ course.credits }} Credits
                </span>
              </div>
            </div>
            <div class="course-action">
              <i class="fas fa-chevron-right"></i>
            </div>
          </div>
        </div>
      </section>

      <!-- Available Courses Section -->
      <section class="available-courses">
        <h3>Available Courses</h3>
        <div *ngIf="availableCourses.length === 0" class="no-content">
          <p>No more courses available to enroll.</p>
        </div>
        <div class="course-list" *ngFor="let course of availableCourses">
          <div class="course-card">
            <div class="course-info">
              <h4>{{ course.title }}</h4>
              <div class="course-details">
                <span *ngIf="course.code" class="course-code">{{
                  course.code
                }}</span>
                <span *ngIf="course.credits" class="course-credits"
                  >{{ course.credits }} Credits</span
                >
              </div>
            </div>
            <div class="course-action">
              <button
                (click)="enrollInCourse(course.id); $event.stopPropagation()"
              >
                Enroll
              </button>
            </div>
          </div>
        </div>
      </section>

      <section class="course-instructors">
        <h3>Course Instructors</h3>
        <div class="instructor-list" *ngFor="let instructor of instructors">
          <div class="instructor-card">
            <img src="{{ instructor.image }}" alt="{{ instructor.name }}" />
            <span>{{ instructor.name }}</span>
          </div>
        </div>
      </section>

      <!-- Messages Section -->
      <section class="messages-section">
        <div class="messages-header">
          <h3>Messages</h3>
          <span *ngIf="unreadCount > 0" class="unread-badge"
            >{{ unreadCount }} Unread</span
          >
        </div>

        <!-- Loading State -->
        <div *ngIf="isLoadingMessages" class="loading-messages">
          <div class="loading-spinner"></div>
          <p>Loading messages...</p>
        </div>

        <!-- No Messages -->
        <div
          *ngIf="!isLoadingMessages && receivedMessages.length === 0"
          class="no-messages"
        >
          <p>No messages yet.</p>
        </div>

        <!-- Messages List and Detail View -->
        <div
          *ngIf="!isLoadingMessages && receivedMessages.length > 0"
          class="messages-container"
        >
          <!-- Messages List -->
          <div class="messages-list">
            <div
              *ngFor="let message of receivedMessages"
              class="message-item"
              [class.unread]="!message.isRead"
              [class.selected]="selectedMessage?.id === message.id"
              (click)="selectMessage(message)"
            >
              <div class="message-sender">
                <span class="sender-name">{{ message.sender.name }}</span>
                <span class="sender-email">{{ message.sender.email }}</span>
              </div>
              <div class="message-preview">
                <p class="subject">{{ message.subject }}</p>
                <p class="body-preview">
                  {{ message.body | slice: 0 : 50 }}...
                </p>
              </div>
              <div class="message-meta">
                <span class="date">{{ formatDate(message.createdAt) }}</span>
                <span *ngIf="!message.isRead" class="unread-indicator">•</span>
              </div>
            </div>
          </div>

          <!-- Message Detail View -->
          <div *ngIf="selectedMessage" class="message-detail">
            <div class="detail-header">
              <button class="close-button" (click)="selectedMessage = null">
                ×
              </button>
              <h4>{{ selectedMessage.subject }}</h4>
              <p class="detail-sender">
                From: {{ selectedMessage.sender.name }} &lt;{{
                  selectedMessage.sender.email
                }}&gt;
              </p>
            </div>

            <div class="message-body">
              {{ selectedMessage.body }}
            </div>

            <div class="message-actions">
              <button
                *ngIf="!showMessageReply"
                class="reply-button"
                (click)="openReplyForm()"
              >
                Reply
              </button>
              <button
                class="delete-button"
                (click)="deleteMessage(selectedMessage.id)"
              >
                Delete
              </button>
            </div>

            <!-- Reply Form -->
            <div *ngIf="showMessageReply" class="reply-form">
              <h5>Reply to {{ selectedMessage.sender.name }}</h5>
              <textarea
                [(ngModel)]="messageReplyText"
                placeholder="Type your reply..."
                rows="5"
                class="reply-textarea"
              ></textarea>
              <div class="reply-actions">
                <button
                  class="send-button"
                  (click)="sendReply()"
                  [disabled]="isReplyLoading || !messageReplyText.trim()"
                >
                  {{ isReplyLoading ? "Sending..." : "Send Reply" }}
                </button>
                <button
                  class="cancel-button"
                  (click)="closeReplyForm()"
                  [disabled]="isReplyLoading"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>
</div>
